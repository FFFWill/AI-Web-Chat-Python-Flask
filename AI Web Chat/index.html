<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <link href="http://[{{ipv6_address}}]:83/ZS/TB_F2.jpg" rel="shortcut icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å¯¹è¯åŠ©æ‰‹</title>
    <style>
        :root {
            --primary-color: #10a37f;
            --secondary-color: #0d8a6b;
            --bg-color: #f0f2f5;
            --control-bg: #2c3e50;
            --control-text: #ecf0f1;
        }

        body {
            background-image: url('http://[{{ipv6_address}}]:83/ZS/BJ_ayanami01.png');
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            max-width: 800px;
            margin: 0 auto;
            height: 100vh;
            box-sizing: border-box;
        }

        #chat-container {
            height: 70vh;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            background: white;
            margin-bottom: 20px;
            border: 2px solid black;
            padding-right: 10px;
        }

        .message {
            margin: 12px 0;
            display: flex;
            gap: 15px;
        }

        .user-message {
            justify-content: flex-end;
        }

        .message-content {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 8px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-all;
        }

        .assistant-message .message-content {
            background: #f8f9fa;
            border: 2px solid black;
            box-shadow: 2px 2px 0 black;
        }

        .user-message .message-content {
            background: var(--primary-color);
            color: white;
        }

        #input-container {
            display: flex;
            gap: 10px;
        }

        #user-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            resize: none;
            min-height: 44px;
            border: 2px solid black;
        }

        button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: opacity 0.2s;
            border: 2px solid black;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .controls-container {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 10px 20px;
            background: var(--control-bg);
            color: var(--control-text);
            border-radius: 25px;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .control-btn:hover {
            background: var(--secondary-color);
        }

        .control-btn.active {
            background: var(--primary-color) !important;
            border: 2px solid var(--secondary-color) !important;
            box-shadow: 0 0 8px var(--secondary-color) inset !important;
        }

        .config-float-ball {
            position: absolute;  /* æ”¹ä¸ºç»å¯¹å®šä½ */
            bottom: 20px;
            right: 25px;         /* è·å³è¾¹15px */
            top: 25px;           /* è·é¡¶éƒ¨15px */
            opacity: 0.8;        /* è°ƒæ•´é€æ˜åº¦ */
            z-index: 10;         /* ç¡®ä¿æ‚¬æµ®çƒåœ¨å†…å®¹ä¹‹ä¸Š */
            background: var(--control-bg);
            color: var(--control-text);
            padding: 15px;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .config-float-ball:hover {
            background: var(--secondary-color);
        }

        .config-menu {
            position: fixed;     /* ä¿æŒå›ºå®šå®šä½ */
            bottom: calc(30% - 70px);  /* ç›¸å¯¹äºæ‚¬æµ®çƒä½ç½®è°ƒæ•´ */
            right: 20px;
            transform: translateX(calc(-14% + 50px)); /* æ°´å¹³åç§»è°ƒæ•´ */
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            width: 350px;
        }

        .config-menu.active {
            opacity: 1;
            visibility: visible;
        }

        .config-menu h3 {
            margin: 0 0 10px;
            color: var(--primary-color);
        }

        .config-menu .setting-group {
            margin-bottom: 15px;
        }

        .config-menu label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .config-menu select,
        .config-menu input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .typing-indicator {
            display: inline-block;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            position: relative;
            top: -2px;
        }

        .dot {
            display: inline-block;
            width: 7px;
            height: 7px;
            margin-right: 4px;
            background: #555;
            border-radius: 50%;
            animation: bounce 1.4s infinite;
        }

        @keyframes bounce {
            0%, 80%, 100% { transform: translateY(0) }
            40% { transform: translateY(-6px) }
        }

        .markdown-content {
            line-height: 1.6;
            font-size: 14px;
        }

        .markdown-content p {
            margin: 10px 0;
        }

        .markdown-content code {
            background: #f8f9fa;
            padding: 2px 5px;
            border-radius: 4px;
            font-family: monospace;
        }

        .control-btn.active i::after {
            content: "âœ“";
            margin-left: 4px;
            color: white;
            font-size: 0.8em;
            animation: bounceIn 0.3s;
        }

        @keyframes bounceIn {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .control-btn:active {
            transform: scale(0.95);
            transition: transform 0.1s;
        }

        .control-btn.active:hover {
            background: var(--secondary-color);
        }
        #function-select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 5px;
        }
        .config-menu .setting-group:nth-child(6) { /* æ–°å¢çš„ç¬¬å…­ä¸ªè®¾ç½®ç»„ */
            margin-top: 15px;
        }
    </style>
</head>
<body>



    <div id="chat-container">
        <div class="config-float-ball" onclick="toggleConfigMenu()">
            <i>âš™ï¸</i>
        </div>
    </div>
    <div id="input-container">
        <textarea id="user-input" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="1"></textarea>
        <button id="send-btn" onclick="sendMessage()">å‘é€</button>
    </div>

    <div class="controls-container">
        <!-- æ–°å¢åœæ­¢ç”ŸæˆæŒ‰é’® -->
        <button class="control-btn" id="stop-btn" onclick="stopGeneration()">
            <i>â¹ï¸</i>
            <span>åœæ­¢ç”Ÿæˆ</span>
        </button>

        <button class="control-btn" id="memory-toggle" onclick="toggleMemory()">
            <i>âœ‰</i>
            <span>çŸ­æœŸè®°å¿†</span>
        </button>
        <button class="control-btn" id="database-toggle" onclick="toggleDatabase()">
            <i>ğŸ’½</i>
            <span>æ•°æ®åº“æ£€ç´¢</span>
        </button>
        <button class="control-btn" id="function-toggle" onclick="toggleFunction()">
            <i>â„±</i>
            <span>æ‰§è¡Œå‡½æ•°</span>
        </button>

        <input type="file" id="image-upload" accept=".png,.jpg" style="display: none;">
        <button class="control-btn" id="upload-toggle" onclick="document.getElementById('image-upload').click()">
            <i>ğŸ–¼ï¸</i>
            <span>ä¸Šä¼ å›¾ç‰‡</span>
        </button>

    </div>


    <div class="config-menu" id="config-menu">
        <h3>è®¾ç½®</h3>
        <div class="setting-group">
            <label>å¼•ç”¨å†å²è®°å½•æ•°ï¼š</label>
            <select id="re-chatlist" onchange="updateSettings()">
                <option value="1">1</option>
                <option value="2" selected>2</option>
                <option value="3">3</option>
                <option value="custom">è‡ªå®šä¹‰</option>
            </select>
            <input type="number" id="custom-re-chatlist" style="display: none; width: 60px;" min="1" placeholder="è¾“å…¥æ•°å­—">
        </div>

        <div class="setting-group">
            <label>å†å²è®°å½•é•¿åº¦ï¼š</label>
            <select id="max-history-length" onchange="updateSettings()">
                <option value="50">50</option>
                <option value="100">100</option>
                <option value="150" selected>150</option>
                <option value="custom">è‡ªå®šä¹‰</option>
            </select>
            <input type="number" id="custom-max-history" style="display: none; width: 60px;" min="1" placeholder="è¾“å…¥æ•°å­—">
        </div>

        <div class="setting-group">
            <label>æ•°æ®åº“ç»“æœæ•°ï¼š</label>
            <select id="max-results" onchange="updateSettings()">
                <option value="1">1</option>
                <option value="2" selected>2</option>
                <option value="3">3</option>
                <option value="custom">è‡ªå®šä¹‰</option>
            </select>
            <input type="number" id="custom-max-results" style="display: none; width: 60px;" min="1" placeholder="è¾“å…¥æ•°å­—">
        </div>

        <div class="setting-group">
            <label>å•ä»½èµ„æ–™åº“å­—æ•°ï¼š</label>
            <select id="re-max-listku" onchange="updateSettings()">
                <option value="50">50</option>
                <option value="100">100</option>
                <option value="150" selected>150</option>
                <option value="custom">è‡ªå®šä¹‰</option>
            </select>
            <input type="number" id="custom-re-max-listku" style="display: none; width: 60px;" min="1" placeholder="è¾“å…¥æ•°å­—">
        </div>

        <div class="setting-group">
            <label>æ¨¡å‹é€‰æ‹©ï¼š</label>
            <select id="model-select" onchange="updateModel()" style="width: 100%;">
                <option value="deepseek-r1:8b">deepseek-r1:8b (é»˜è®¤)</option>
                <option value="huihui_ai/deepseek-r1-abliterated:8b">deepseek-r1:8bæ— é™åˆ¶ç‰ˆæœ¬</option>
                <option value="deepseek-r1:1.5b">deepseek-r1:1.5bç‰ˆæœ¬</option>
                <option value="deepseek-r1:7b">deepseek-r1:7bç‰ˆæœ¬</option>
                <option value="deepseek-r1:14b">deepseek-r1:14bç‰ˆæœ¬</option>
            </select>
        </div>

        <div class="setting-group">
            <label>é€‰æ‹©æ‰§è¡Œå‡½æ•°ï¼š</label>
            <select id="function-select" onchange="updateSelectedFunction()">
                <option value="">è¯·é€‰æ‹©åŠŸèƒ½è„šæœ¬</option>
            </select>
        </div>

        <div class="setting-group">
            <label>å‡½æ•°è¿”å›å­—æ•°é™åˆ¶ï¼š</label>
            <select id="max-func-length" onchange="updateSettings()">
                <option value="50">50</option>
                <option value="100">100</option>
                <option value="150" selected>150</option>
                <option value="custom">è‡ªå®šä¹‰</option>
            </select>
            <input type="number" id="custom-max-func" style="display: none; width: 60px;" min="1" placeholder="è¾“å…¥æ•°å­—">
        </div>

    </div>

    <script>
        let useFunction = false;
        let selectedFunction = '';
        let currentUpload = null;
        window.onload = function() {
            // åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
            document.getElementById('memory-toggle').classList.toggle('active', useMemory);
            document.getElementById('database-toggle').classList.toggle('active', useDatabase);

            // ç»‘å®šä¸‹æ‹‰èœå•äº‹ä»¶
            document.querySelectorAll('select').forEach(select => {
                select.addEventListener('change', (e) => {
                    const customInput = document.getElementById(`custom-${e.target.id}`);
                    if (e.target.value === 'custom') {
                        customInput.style.display = 'inline';
                    } else {
                        customInput.style.display = 'none';
                    }
                    updateSettings();
                });
            });

            // åŠ è½½å‡½æ•°åˆ—è¡¨
            loadFunctions();
        };

        document.getElementById('image-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // éªŒè¯æ–‡ä»¶ç±»å‹
            if (!file.name.match(/\.(png|jpg)$/i)) {
                alert('ä»…æ”¯æŒPNG/JPGæ ¼å¼');
                return;
            }

            // æ˜¾ç¤ºä¸Šä¼ çŠ¶æ€
            const uploadBtn = document.getElementById('upload-toggle');
            uploadBtn.innerHTML = '<i>â³</i><span>ä¸Šä¼ ä¸­...</span>';
            uploadBtn.disabled = true;

            try {
                const formData = new FormData();
                formData.append('image', file);

                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(`ä¸Šä¼ æˆåŠŸï¼š${result.filename}`);
                    // è¿™é‡Œå¯ä»¥æ·»åŠ å›¾ç‰‡é¢„è§ˆæˆ–åç»­å¤„ç†é€»è¾‘
                } else {
                    throw new Error('ä¸Šä¼ å¤±è´¥');
                }
            } catch (error) {
                alert(`ä¸Šä¼ é”™è¯¯ï¼š${error.message}`);
            } finally {
                uploadBtn.innerHTML = '<i>ğŸ–¼ï¸</i><span>ä¸Šä¼ å›¾ç‰‡</span>';
                uploadBtn.disabled = false;
                e.target.value = ''; // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
            }
        });

        async function loadFunctions() {
            try {
                const response = await fetch('/api/list_funcs');
                const data = await response.json();
                const select = document.getElementById('function-select');

                // æ¸…ç©ºç°æœ‰é€‰é¡¹
                select.innerHTML = '<option value="">è¯·é€‰æ‹©åŠŸèƒ½è„šæœ¬</option>';

                data.funcs.forEach(func => {
                    const option = document.createElement('option');
                    option.value = func;
                    option.textContent = func;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('åŠ è½½å‡½æ•°åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        function toggleFunction() {
            useFunction = !useFunction;
            document.getElementById('function-toggle').classList.toggle('active', useFunction);
            if (!useFunction) selectedFunction = '';
        }

        function updateSelectedFunction() {
            selectedFunction = document.getElementById('function-select').value;
        }


        let useMemory = true;
        let useDatabase = true;
        let configMenuVisible = false;

        let currentSettings = {
            re_chatlist: 2,
            max_history_length: 150,
            max_results: 2,
            re_max_listku: 150,
            max_func_length: 150,
            modname: 'deepseek-r1:8b'
        };

        function updateSettings() {
            // å†å²è®°å½•æ•°å¤„ç†
            const reChatlistSelect = document.getElementById('re-chatlist');
            const customReChatlistInput = document.getElementById('custom-re-chatlist');

            if (reChatlistSelect.value === 'custom') {
                customReChatlistInput.style.display = 'inline';
                // æ·»åŠ è¾“å…¥ç›‘å¬
                customReChatlistInput.addEventListener('input', () => {
                    currentSettings.re_chatlist = parseInt(customReChatlistInput.value) || 2;
                });
            } else {
                customReChatlistInput.style.display = 'none';
                currentSettings.re_chatlist = parseInt(reChatlistSelect.value);
            }

            // å†å²è®°å½•é•¿åº¦å¤„ç†
            const maxHistorySelect = document.getElementById('max-history-length');
            const customMaxHistoryInput = document.getElementById('custom-max-history');

            if (maxHistorySelect.value === 'custom') {
                customMaxHistoryInput.style.display = 'inline';
                // æ·»åŠ è¾“å…¥ç›‘å¬
                customMaxHistoryInput.addEventListener('input', () => {
                    currentSettings.max_history_length = parseInt(customMaxHistoryInput.value) || 150;
                });
            } else {
                customMaxHistoryInput.style.display = 'none';
                currentSettings.max_history_length = parseInt(maxHistorySelect.value);
            }

            // ä¿æŒåŸæœ‰æ•°æ®åº“ç»“æœæ•°å¤„ç†é€»è¾‘
            const maxResultsSelect = document.getElementById('max-results');
            const maxResultsInput = document.getElementById('custom-max-results');

            if (maxResultsSelect.value === 'custom') {
                maxResultsInput.style.display = 'inline';
                let value = parseInt(maxResultsInput.value.trim());
                value = isNaN(value) || value < 1 ? 2 : Math.min(value, 100);
                currentSettings.max_results = value;
                // æ·»åŠ è¾“å…¥ç›‘å¬
                maxResultsInput.addEventListener('input', () => {
                    let value = parseInt(maxResultsInput.value.trim());
                    value = isNaN(value) || value < 1 ? 2 : Math.min(value, 100);
                    currentSettings.max_results = value;
                });
            } else {
                maxResultsInput.style.display = 'none';
                currentSettings.max_results = parseInt(maxResultsSelect.value);
            }

            // ä¿æŒåŸæœ‰å•ä»½èµ„æ–™åº“å­—æ•°å¤„ç†é€»è¾‘
            const reMaxListkuSelect = document.getElementById('re-max-listku');
            const reMaxListkuInput = document.getElementById('custom-re-max-listku');

            if (reMaxListkuSelect.value === 'custom') {
                reMaxListkuInput.style.display = 'inline';
                let value = parseInt(reMaxListkuInput.value.trim());
                value = isNaN(value) || value < 1 ? 150 : Math.min(value, 500);
                currentSettings.re_max_listku = value;
                // æ·»åŠ è¾“å…¥ç›‘å¬
                reMaxListkuInput.addEventListener('input', () => {
                    let value = parseInt(reMaxListkuInput.value.trim());
                    value = isNaN(value) || value < 1 ? 150 : Math.min(value, 500);
                    currentSettings.re_max_listku = value;
                });
            } else {
                reMaxListkuInput.style.display = 'none';
                currentSettings.re_max_listku = parseInt(reMaxListkuSelect.value);
            }
            // æ–°å¢å‡½æ•°è¿”å›é™åˆ¶å¤„ç†
            const maxFuncSelect = document.getElementById('max-func-length');
            const maxFuncInput = document.getElementById('custom-max-func');

            if (maxFuncSelect.value === 'custom') {
                maxFuncInput.style.display = 'inline';
                let value = parseInt(maxFuncInput.value.trim());
                value = isNaN(value) || value < 1 ? 150 : Math.min(value, 500);
                currentSettings.max_func_length = value;
                maxFuncInput.addEventListener('input', () => {
                    let value = parseInt(maxFuncInput.value.trim());
                    value = isNaN(value) || value < 1 ? 150 : Math.min(value, 500);
                    currentSettings.max_func_length = value;
                });
            } else {
                maxFuncInput.style.display = 'none';
                currentSettings.max_func_length = parseInt(maxFuncSelect.value);
            }
        }



        document.getElementById('custom-max-results').addEventListener('input', updateSettings);
        document.getElementById('custom-re-max-listku').addEventListener('input', updateSettings);

        function updateModel() {
            const modelSelect = document.getElementById('model-select');
            currentSettings.modname = modelSelect.value;
        }

        function toggleMemory() {
            useMemory = !useMemory;
            document.getElementById('memory-toggle').classList.toggle('active', useMemory);
        }

        function toggleDatabase() {
            useDatabase = !useDatabase;
            document.getElementById('database-toggle').classList.toggle('active', useDatabase);
        }

        function toggleConfigMenu() {
            configMenuVisible = !configMenuVisible;
            document.getElementById('config-menu').classList.toggle('active', configMenuVisible);
        }

        // æ–°å¢åœæ­¢ç”Ÿæˆå‡½æ•°
        async function stopGeneration() {
            try {
                const response = await fetch('/api/stop_generation', {
                    method: 'POST'
                });
                if (response.ok) {
                    alert('ç”Ÿæˆå·²åœæ­¢');
                } else {
                    throw new Error('åœæ­¢ç”Ÿæˆè¯·æ±‚å¤±è´¥');
                }
            } catch (error) {
                alert(`åœæ­¢ç”Ÿæˆå¤±è´¥: ${error.message}`);
            }
        }

        // ä¿æŒå‰©ä½™JavaScripté€»è¾‘ä¸å˜
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');

        let autoScrollEnabled = true;

        chatContainer.addEventListener('scroll', () => {
            const atBottom = chatContainer.scrollHeight - chatContainer.scrollTop === chatContainer.clientHeight;
            autoScrollEnabled = atBottom;
        });

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function addUserMessage(content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user-message';
            messageDiv.innerHTML = `
                <div class="message-content">${content}</div>
            `;
            chatContainer.appendChild(messageDiv);
        }

        async function addAssistantMessageStream() {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant-message';
            messageDiv.innerHTML = `
                <div class="message-content markdown-content">
                    <span class="typing-indicator">
                        <span class="dot"></span>
                        <span class="dot" style="animation-delay: 0.2s"></span>
                        <span class="dot" style="animation-delay: 0.4s"></span>
                    </span>
                </div>
            `;
            chatContainer.appendChild(messageDiv);
            return messageDiv.querySelector('.message-content');
        }

        async function sendMessage() {
            const content = userInput.value.trim();
            if (!content) return;

            sendBtn.disabled = true;
            userInput.disabled = true;
            userInput.value = '';

            addUserMessage(content);
            const responseContainer = await addAssistantMessageStream();

            try {
                let funcResult = '';
                if (useFunction && selectedFunction) {
                    try {
                        // ä¿®æ”¹è¿™ä¸€è¡Œ
const funcResponse = await fetch(`/api/run_func?func=${encodeURIComponent(selectedFunction)}&max_func_length=${currentSettings.max_func_length}&raw_input=${encodeURIComponent(content)}`);
                        if (!funcResponse.ok) throw new Error('å‡½æ•°æ‰§è¡Œå¤±è´¥');
                        funcResult = await funcResponse.text();
                    } catch (funcError) {
                        funcResult = `å‡½æ•°æ‰§è¡Œé”™è¯¯: ${funcError.message}`;
                    }
                }

                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: content,
                        useMemory: useMemory,
                        useDatabase: useDatabase,
                        currentFunc: funcResult,
                        settings: currentSettings
                    })
                });

                if (!response.ok) throw new Error('è¯·æ±‚å¤±è´¥');

                autoScrollEnabled = true;
                await createStreamTypewriter(response.body, responseContainer, {});

                if (autoScrollEnabled) {
                    scrollToBottom();
                }
            } catch (error) {
                responseContainer.innerHTML = 'âŒ è¯·æ±‚å‡ºé”™: ' + error.message;
            } finally {
                sendBtn.disabled = false;
                userInput.disabled = false;
                userInput.focus();
            }
        }
        // åˆå§‹åŒ–æ—¶ç»‘å®šæ–°è®¾ç½®ç»„çš„ç›‘å¬
        document.getElementById('max-func-length').addEventListener('change', updateSettings);
        document.getElementById('custom-max-func').addEventListener('input', updateSettings);
        // åˆå§‹åŒ–æ—¶æ·»åŠ äº‹ä»¶ç›‘å¬ï¼ˆä¿®æ”¹åçš„éƒ¨åˆ†ï¼‰
        document.querySelectorAll('select').forEach(select => {
            select.addEventListener('change', (e) => {
                const customInput = document.getElementById(`custom-${e.target.id}`);
                if (e.target.value === 'custom') {
                    customInput.style.display = 'inline';
                    customInput.value = '';
                    // åˆå§‹åŒ–æ—¶è®¾ç½®é»˜è®¤å€¼
                    if(customInput.id === 'custom-re-chatlist') {
                        currentSettings.re_chatlist = 2;
                    }
                    if(customInput.id === 'custom-max-history') {
                        currentSettings.max_history_length = 150;
                    }
                } else {
                    customInput.style.display = 'none';
                    // ç§»é™¤ç›‘å¬é¿å…é‡å¤ç»‘å®š
                    customInput.removeEventListener('input', updateSettings);
                }
                updateSettings();
            });
        });

        // æ·»åŠ è¾“å…¥æ¡†çš„åˆå§‹ç›‘å¬
        document.getElementById('custom-re-chatlist').addEventListener('input', updateSettings);
        document.getElementById('custom-max-history').addEventListener('input', updateSettings);

        document.querySelectorAll('select').forEach(select => {
            if (select.value === 'custom') {
                document.getElementById(`custom-${select.id}`).style.display = 'inline';
            }
        });

        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey && !e.ctrlKey) {
                e.preventDefault();
                sendMessage();
            } else if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                userInput.value += '\n';
            }
        });

        async function createStreamTypewriter(stream, container, options = {}) {
            const config = { baseSpeed: 50, maxSpeedup: 3, retryCount: 3, ...options };

            let isDestroyed = false;
            let cursorVisible = true;
            let renderQueue = [];

            const cursor = document.createElement('span');
            cursor.className = 'typewriter-cursor';
            cursor.textContent = 'â–Œ';
            container.append(cursor);

            const cursorInterval = setInterval(() => {
                if (!isDestroyed) {
                    cursor.style.opacity = cursorVisible ? 1 : 0;
                    cursorVisible = !cursorVisible;
                }
            }, 600);

            const renderEngine = () => {
                if (renderQueue.length === 0 || isDestroyed) return;

                const speed = Math.max(config.baseSpeed / config.maxSpeedup, config.baseSpeed - renderQueue.length * 2);

                const fragment = document.createDocumentFragment();
                while (renderQueue.length > 0) {
                    const char = renderQueue.shift();
                    if (char === '\n') {
                        fragment.appendChild(document.createElement('br'));
                    } else if (char === ' ') {
                        // å°†æ™®é€šç©ºæ ¼æ›¿æ¢ä¸º &nbsp; ä»¥ä¿ç•™ç¼©è¿›
                        const nbsp = document.createTextNode('\u00A0');
                        fragment.appendChild(nbsp);
                    } else {
                        fragment.append(document.createTextNode(char));
                    }
                }

                container.insertBefore(fragment, cursor);
                setTimeout(() => requestAnimationFrame(renderEngine), speed);

                if (autoScrollEnabled) {
                    scrollToBottom();
                }
            };

            const processStream = async () => {
                try {
                    const reader = stream.getReader();
                    while (!isDestroyed) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        // è§£ç æµå†…å®¹ï¼Œå¹¶å°†æ™®é€šç©ºæ ¼æ›¿æ¢ä¸ºç‰¹æ®Šå­—ç¬¦ä»¥ä¿ç•™æ ¼å¼
                        const decodedText = new TextDecoder().decode(value);
                        renderQueue.push(...decodedText.split('').map(char => char === ' ' ? '\u00A0' : char)); // æ›¿æ¢ç©ºæ ¼ä¸º &nbsp; çš„ç­‰æ•ˆå­—ç¬¦

                        if (!renderQueue.length) continue;
                        requestAnimationFrame(renderEngine);
                    }

                    // æ¸…ç†å·¥ä½œï¼šç§»é™¤å…‰æ ‡å’Œå¯èƒ½çš„æ‰“å­—åŠ¨ç”»
                    isDestroyed = true;
                    clearInterval(cursorInterval);
                    cursor.remove();

                    // æŸ¥æ‰¾å¹¶ç§»é™¤ `.typing-indicator`
                    const typingIndicator = container.querySelector('.typing-indicator');
                    if (typingIndicator) {
                        typingIndicator.remove();
                    }
                } catch (err) {
                    isDestroyed = true;
                    clearInterval(cursorInterval);
                    cursor.remove();

                    // åŒæ ·ç§»é™¤ `.typing-indicator` ä»¥é˜²å‡ºé”™æ—¶æ®‹ç•™
                    const typingIndicator = container.querySelector('.typing-indicator');
                    if (typingIndicator) {
                        typingIndicator.remove();
                    }
                    throw new Error('Stream connection failed');
                }
            };

            processStream();
        }
    </script>
</body>
</html>